---
layout:	post
title:	shell编程之系统进程监控
categories:
- TECHNOLOGY
tags:
- Shell
permalink:  Explore-systemMonitor-shell
comments:	true
---
本问内容均是根据网络上一篇博文[使用shell脚本对linux系统和进程资源进行监控](http://blog.jobbole.com/22318/)对其验证学习的总结.
<!-- more -->


## 命令支持
* `ps`	查看系统中瞬间进程信息
	* `-u`	指定所属用户
* `grep`	查找文件中符号字符串的当前行
	* `-v`	反向选择,用于剔除包含'某些字符串'的行
* `sed`	一个非交互性文本编辑器，它编辑文件或标准输入导出的文件，一次只能处理一行内容
	* `-n`	读取下一个输入行，用下一个命令处理新的行而不是用第一个命令(同时阻止sed的自动输出)
* `awk`	每接收文件的一行，然后执行相应的命令，来处理文本
* `vimstat`	展现给定时间间隔的服务器的状态值,包括服务器的CPU使用率，内存使用，虚拟内存交换情况,IO读写情况
* `bc`	数字计算

## 获取进程id
* 代码演示

	```bash
	#! /bin/bash
	# 通过进程的使用者和名称来获取进程的PID

	# 提示脚本用法
	if [ "$#" -ne 2 ]
	then
		echo "Usage: $0 pUser pName"
		exit 1
	fi

	pUser=$1
	pName=$2
	pId=`ps -u $pUser | grep $pName | grep -v 'grep' | grep -v 'vi' | grep -v 'dbx\n' | grep -v 'tail' | grep -v 'start' | grep -v 'stop' | sed -n 1p | awk '{print $1}'`

	# 检测进程是否存在
	if [ "-$pId" == "-" ]
	then
		echo "The process does not exist."
	else
		echo $pId
	fi
	```
* 个人理解
在获取pId的命令中,ps挑选用户,再用grep查找进程,剔除掉包含grep,vi,dbx,tail,start,stop的命令行==[不懂为嘛]==,sed选取第一行,awk提取出pId.

## 监控进程使用的CPU&内存
* 监控CPU

	```bash
	# 通过pId来获取该进程CPU的使用情况
	function GetCpu
	{
		cpuValue=`ps -p $1 -o pcpu | grep -v CPU | awk '{print $1}' | awk -F. '{print $1}'`
		echo $cpuValue
	}
	```
	> **注意:**  
	> 最后的`awk`是取整的目的.
* 监控内存

	```bash
	# 通过pId来获取进程内存使用情况
	function GetMem
	{
		memUsage=`ps -p $1 -o vsz | grep -v VSZ`
		((memUsage /= 1000))
		echo $memUsage
	}
	```
* 句柄数
句柄使用过高可能由于负载过高，句柄泄露等情况，通过脚本对业务进程句柄使用量进行时时监控，可以在异常时及时发送告警（例如通过短信），便于维护人员及时处理

	```bash
	# 通过pId来获取该进程句柄使用量
	function GetHandle
	{
		handle=`ls /proc/$1/fd | wc -l`
		echo $handle
	}
	```
* 监控系统CPU

	```bash
	# 获取系统CPU负载
	function GetSysCpu
	{
		cpuIdle=`vmstat 1 5 | sed -n '3,$p' | awk '{x = x + $15} END {print x/5}' | awk -F. '{print $1}'`
		cpuNum=`echo "100-$cpuIdle" | bc`
		echo $cpuNum
	}
	```
	> **注解:**  
	> 使用 vmstat 取 5 次系统 CPU 的 idle 值，取平均值，然后通过与 100 取差得到当前 CPU 的实际占用值。

## 完整演示
* 代码文件[checkPerform.sh]({{ site.baseurl }}/assets/attachs/checkPerform.sh.txt)
* 效果演示
查询由hjy打开的google浏览器chromium的使用情况
![perform]({{ site.baseurl }}/assets/images/perform.png)
* 结果分析
==目前google浏览器cpu使用占3%,而整个系统的cpu使用是5%.内存使用是2210M,超了不少,运行的进程有40个,也超了不少,而占用的句柄数是426,也是比较多的.==
