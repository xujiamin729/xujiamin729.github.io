---
layout: post
title: 从零开始搭建https服务器
categories:
- TECHNOLOGY
tags:
- Cloud
- Nginx
- Python
permalink: https-server
comments: true
date: 2017-01-24 21:03:12
---
写这篇文章的目的是为了开发微信小程序。因为它要使用wx.request发起https请求，而要进行https网络通信，必须先设置域名。所以需要搭建一个https服务器来存放微信小程序的应用数据。要从零开始搭建一个https的服务需要下面4个要素：域名，备案，云服务器，服务器配置。下面分别介绍着四要素的具体要求。
<!-- more -->

## 域名
[域名][wiki-domain]（`Domain Name`）又叫网域，是由一串用点分隔的名字组成的Internet上某一台计算机或计算机组的名称，用于在数据传输时标识计算机的电子方位。例如，www.haojunyu.com是一个域名，可以通过域名名称系统（`Domain Name System`）将该域名映射成对应的IP地址。该操作可以通过域名解析来实现。

### 域名注册和解析
域名注册前，可以通过[WHOIS域名查询][whois]来查询该域名是否被注册过。目前BAT都提供域名注册，如阿里的[万网],百度的[域名服务][baiduyuming]，腾讯的[Dnspod]。我的域名haojunyu.com是在阿里的万网注册的，之前注册域名的初衷是为了给github上面的个人博客作个性化的域名。并在其中的域名解析中作了设置，这里并不需要做太多的改动，只要将之前为个人博客添加的记录都暂停，并添加如下解析：记录类型为，主机记录为@，解析线路为默认，记录值为欲映射的IP。这样的话，当你在浏览器中输入haojunyu.com时，DNS会自动将其解析为映射的IP地址。

## 备案
这里的备案是针对像个人博客这类非经营性网站所做的备案。守法的网站对促进信息共享、文化繁荣和社会进步产生积极的作用，但有些不良的网站却传递色情，非法盈利的信息，所以备案的目的也就是为了方便网站的管理。

目前网站域名的备案BAT都能提供，不过备案这个流程很长，大概要一个月，我的域名haojunyu.com是在百度云备案的，当时是先提交的资料（主要是身份证正反面照片），然后等百度快递来背景墙，再拍照片上传核实后才可以备案成功。

## 云服务器
服务器就是一台可以运行的电脑，可以是自己家里的电脑，也可以到BAT上买云服务。这里因为腾讯云上面有免费8天的试用，所以就试着在云服务上面搭建个https的服务，以方便微信小程序能成功发起request请求。如果试用体验还不错的话，可以续费（74元/月）。新建云主机时要选一个操作系统，鉴于对Ubutnu的熟悉以及服务器的需要，所以选择了Ubuntu Server 16.04.1 LTS 64的镜像做系统。当新建一个云主机后，百度云会提供一个对外的IP地址，这个IP地址就是域名解析中要填入的记录值。

## 服务器配置
服务器的配置主要有三步个，第一步是应用程序的布置，第二步是Nginx服务器的配置，第三步是http升级为https。前两步的配置是参考这篇博文[在Ubuntu上使用Nginx部署Flask应用][deploy-flask]，第三步是参考[腾讯云上Nginx证书安装][nginx-https]。
### 应用程序
考虑到微信小程序主要是用json的数据，所以就想服务器能够提供restful服务，又因为对python语言比较喜欢，所以就挑了python里的Flask这个轻量级的Web框架。服务器选择的是Nginx，而连接服务器和应用程序的是uWSGI。具体的安装步骤如下：
1. 环境配置
  ```bash
    sudo apt-get update && sudo apt-get upgrade # 更新所有软件
    sudo apt-get install build-essential  # 安装编译环境
    sudo apt-get install  python python-dev python-setuptools # 安装python环境
    sudo easy_install pip
    sudo apt-get install nginx  # 安装Nginx
    sudo apt-get install uwsgi uwsgi-plugin-python  # 安装uwsgi及其插件
    sudo apt-get install supervisor # 安装进程管理软件
  ```
  > **TIPS:常用命令**
  > 1. nginx服务启动|停止|重启
  > ```bash
      sudo /etc/init.d/nginx start|stop|restart
    ```
  > 2. sdf

2. 应用配置
  ```bash
    sudo mkdir -p /var/www/flaskApp # 创建应用程序文件夹
    sudo chown -R ubuntu：ubuntu /var/www/flaskApp # 更改应用程序文件夹所有权
    sudo pip install virtualenv # 安装python虚拟环境
    # 创建python虚拟环境
    cd /var/www/flaskApp
    virtualenv venv
    . venv/bin/activate # 激活python虚拟环境venv
    pip install flask flask-restful # 在虚拟环境中安装flask Web框架
  ```
  创建api.py代码
  ```python
  #!flask/bin/python
  from flask import Flask, jsonify

  app = Flask(__name__)

  tasks = [
      {
          'id': 1,
          'title': u'Buy groceries',
          'description': u'Milk, Cheese, Pizza, Fruit, Tylenol',
          'done': False
      },
      {
          'id': 2,
          'title': u'Learn Python',
          'description': u'Need to find a good Python tutorial on the web',
          'done': False
      }
  ]

  @app.route('/todo/api/v1.0/tasks', methods=['GET'])
  def get_tasks():
      return jsonify({'tasks': tasks})

  if __name__ == '__main__':
      app.run(host='0.0.0.0', port=8080)
  ```

  执行脚本`python api.py`后可以通过浏览器来访问http://主机IP:8080/todo/api/v1.0/tasks，以此来获取tasks数据。

### 服务器配置
#### Nginx配置
  1. 删除nginx默认配置文件
  ``` bash
    sudo rm /etc/nginx/sites-enabled/default
  ```
  2. 创建新的配置文件/var/www/flaskApp/config/flaskApp_nginx.conf
  ```bash
  server {
    listen      80;
    server_name www.haojunyu.com; #此时域名已经映射到主机IP
    charset     utf-8;
    client_max_body_size 75M;

    location / { try_files $uri @yourapplication; }
    location @yourapplication {
        include uwsgi_params;
        uwsgi_pass unix:/var/www/flaskApp/config/flaskApp_uwsgi.sock;
    }
  }
  ```
  3. 创建配置文件服务，重启服务
  ```bash
    sudo ln -s /var/www/flaskApp/config/nginx.conf /etc/nginx/conf.d/ #将应用文件夹里的配置文件链接到nginx配置文件处
    sudo /etc/init.d/nginx restart  # 重启nginx
  ```
  4. 验证
  现在通过浏览器来访问http://haojunyu.com/todo/api/v1.0/tasks，无法获取到数据，因为flaskApp_uwsgi.sock尚未生成，无法让uwsgi在Nginx和python应用程序之间构建一座桥。

#### uWSGI配置
  1. 创建新的配置文件/var/www/flaskApp/config/flaskApp_uwsgi.ini
  ```bash
  [uwsgi]
  #application's base folder
  base = /var/www/flaskApp

  #python module to import
  app = api
  module = %(app)

  home = %(base)/venv
  pythonpath = %(base)
  ## 使用virtualenvwrapper管理virtualenv后用下面的两个参数取代home和pythonpath
  #chdir = %(base)
  #virtualenvs = %HOME/.virtualenvs/flaskEnv

  #socket file's location
  socket = /var/www/flaskApp/%n.sock

  #permissions for the socket file
  chmod-socket    = 666

  #the variable that holds a flask application inside the module imported at line #6
  callable = app

  #location of log files
  logto = /var/log/uwsgi/%n.log
  ```
  2. 创建uWSGI日志文件夹，并更改文件所有权
  ```bash
  sudo mkdir -p /var/log/uwsgi # uWSGI日志文件夹
  sudo chown -R ubuntu:ubuntu /var/log/uwsgi # 更改uWSGI日志文件夹所有权
  uwsgi --ini /var/www/flaskApp/config/flaskApp_uwsgi.ini --plugin python & # 后台启动uwsgi
  ```

#### supervisor配置
supervisor是为了方便管理进程而存在的，因为每次开机后，都得重新执行`uwsgi --ini /var/www/flaskApp/config/flaskApp_uwsgi.ini`命令来启动uwsgi，这个很费神，因为你不可能永远记得清楚这么个应用，这么个配置。所以使用supervisor来管理，而我们只需要在开发这个应用时创建一个flaskApp_supervisor.conf配置文件，而重启机器后启动supervisor服务，即执行`sudo service supervisor start`。
  1. 安装supervisor
  ```bash
  sudo apt install supervisor
  ```
  2. 创建配置文件：
  ```bash
  [program:flaskApp]
  # 启动命令入口
  command=/usr/local/bin/uwsgi --ini /var/www/flaskApp/flaskApp_uwsgi.ini
  # 运行命令的用户名
  user=ubuntu
  autostart=true
  autorestat=true
  #日志地址
  stdout_logfile=/var/log/supervisor/flaskApp_supervisor.log
  ```
  3. 创建配置文件副本并重启服务
  ```bash
  sudo ln -s /var/www/flaskApp/flaskApp_supervisor.conf /etc/supervisor/conf.d/
  sudo service supervisor restart
  ```

### http升级https
升级https需要证书的支持，这里BAT都提供这样的服务，都有相对应的配置安装说明。我这里是按照[腾讯云上Nginx证书安装][nginx-https],主要就是将申请的证书保存到config目录中，并将flaskApp_nginx.conf修改如下：
```bash
server {
  listen      443;
  server_name www.haojunyu.com; #此时域名已经映射到主机IP

  ssl on;
  ssl_certificate /var/www/flaskApp/1_haojunyu.com_bundle.crt;
  ssl_certificate_key /var/www/flaskApp/2_haojunyu.com.key;
  ssl_session_timeout 5m;
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2; #按照这个协议配置
  ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;#按照这个套件配置
  ssl_prefer_server_ciphers on;

  location / { try_files $uri @yourapplication; }
  location @yourapplication {
      include uwsgi_params;
      uwsgi_pass unix:/var/www/flaskApp/config/flaskApp_uwsgi.sock;
  }
}
```


## 参考文献
1. [wiki-域名][wiki-domain]
2. [whois域名查询][whois]
3. [万网][wanwang]
4. [百度域名服务][baiduyuming]
5. [Dnspod][Dnspod]
6. [在Ubuntu上使用Nginx部署Flask应用][deploy-flask]
7. [腾讯云上Nginx证书安装][nginx-https]

[wiki-domain]: https://zh.wikipedia.org/wiki/%E5%9F%9F%E5%90%8D
[whois]: https://who.is/
[wanwang]: https://wanwang.aliyun.com/?spm=5176.8142029.388261.26.C75xLA
[baiduyuming]： https://cloud.baidu.com/product/bcd.html
[Dnspod]: https://dnspod.qcloud.com/?from=console
[deploy-flask]: https://www.oschina.net/translate/serving-flask-with-nginx-on-ubuntu
[nginx-https]: https://www.qcloud.com/document/product/400/4143#2.-nginx-.E8.AF.81.E4.B9.A6.E9.83.A8.E7.BD.B2
