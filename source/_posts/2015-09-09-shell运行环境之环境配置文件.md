---
layout:	post
title:	shell运行环境之环境配置文件
categories:
- TECHNOLOGY
tags:
- Ubuntu
- Shell
permalink:  Explore-configure-Shell
comments:	true
---
[上一篇博文]({{site.baseurl}}/2015/09/08/shell运行环境之环境变量.html)介绍了shell运行环境中三种不同的环境变量--临时变量，用户变量和系统变量，除此之外还有/etc/environment，/etc/profile和～/.profile作用域。这篇文章将主要围绕bash这个shell来讲解[环境配置文件][bash_pro]，并结合shell的四种模式来说明这些配置文件的作用域。
<!-- more -->

## 简介
我们知道linux系统中有很多shell，像最常用的bash，不常用的sh，zsh等。而对于它们公共的变量我们不可能为每个shell重复设置，所以这些公共变量我们将会保存在profile中，而对于每个shell个性化的配置将会放在各自的配置文件中，像bashrc，shrc和zshrc。而ubuntu默认用的是bash，所以只有bashrc而没有其他吧。

## profile配置文件
profile是配置的意思，是某个用户唯一用来设置环境变量的地方，而用户可用的shell有多个，像bash，sh，zsh之类的，但像环境变量这种只需要在统一的一个地方初始化就可以了，这就需要profile。在Ubuntu中[/etc/profile]({{site.baseurl}}/assets/attachs/etc_profile.txt)将在用户**第一次**登录（可以是图形也可以是终端）时被执行，其只做两件事。  

1. 设置shell使用bash（主要执行/etc/bash.bashrc）  
2. 查看/etc/profile.d中是否有相应的环境变量要设置（该文件夹中每个sh文件都是针对某个应用设置的环境变量，这个叫[可插拔功能][pam]）。

而[~/.profile]({{site.baseurl}}/assets/attachs/home.profile.txt)也是在用户**第一次**登录时被执行，其也是做两件事。

1. 设置shell使用bash（主要执行~/.bashrc）
2. 设置路径包含用户私有的执行文件目录（如果存在）

## bashrc配置文件
bashrc看名字就知道，是专门用来给bash做初始化的。像初始化bash的设置，代码补全，别名，颜色等。同理，还会有shrc，zshrc这样的文件存在，只是bash太常用了。在Ubuntu系统中，每次打开bash，[/etc/bash.bashrc]({{site.baseurl}}/assets/attachs/etc_bash.bashrc.txt)就会被执行，进行如下设置。

0. ==非交互模式则不进行下面的操作==
1. 窗口可调整
2. 增强$PS1
3. 设置xterm（注释掉了）
4. 交互模式中开启命令补全（注释掉了）
5. 在bash中使用sudo
6. 安装command-not-found包后bash的变化

而[~/.bashrc]({{site.baseurl}}/assets/attachs/home.bashrc.txt)中设置的就比较多了，具体可以看文档注释。

## 四种不同的[shell模式][bash]
* 登录模式  
进入登录模式的shell需要一个特定的用户名和密码，就像我们按`Ctrl + Alt + F1`进入tty1后输入用户名和密码后成功登录系统的情况。  

	> **Tips:**  
	> 该模式下，shell会自动执行/etc/profile和~/.profile文件，但不会执行任何bashrc文件，但是在这两个profile里面会手动去执行bashrc文件`. *.bashrc`.  
* 非登录模式  
非登录模式是指不用登录直接进入shell，它需要在特定用户登录状态下才能进入。就像在终端下直接输入`bash`或`bash -c ‘CMD’`。
	> **Tips:**  
	> 该模式下，shell不会自动执行profile文件。
* 交互模式  
在交互模式的shell中，标准输入，输出和错误都显示在终端上，此时变量`$PS1`一定会被设置。像以`bash`，`bash -i`命令启动。
	> **Tips:**  
	> 该模式下（未login），shell会去执行/etc/bash.bashrc和~/.bashrc文件。
* 非交互模式  
非交互模式就是指shell里面没有交互，像执行命令`bash -c ‘CMD’`，像运行shell脚本等。
	> **Tips:**  
	> 该模式下，shell不会执行任何bashrc文件。

## 试验
* 验证四种模式中配置文件的作用域  
当我们在终端中执行bash命令的时候，它其实在终端中又开了一个外壳，所以我们需要`exit`两次才能退出。所以我们在第一层外壳中设置四个配置文件中变量。设置如下：

	```sh
	# /etc/profile
	export epro='I am in /etc/profile'
	export epro_ebash='I am in /etc/profile'
	export epro_pro='I am in /etc/profile'
	export epro_bash='I am in /etc/profile'

	# /etc/bash.bashrc
	export ebash='I am in /etc/bash.bashrc'
	export epro_ebash='I am in /etc/bash.bashrc'
	export ebash_pro='I am in /etc/bash.bashrc'
	export ebash_bash='I am in /etc/bash.bashrc'

	# ~/.profile
	export pro='I am in ~/.profile'
	export epro_pro='I am in ~/.profile'
	export ebash_pro='I am in ~/.profile'
	export pro_bash='I am in ~/.profile'

	# ~/.bashrc
	export bash='I am in ~/.bashrc'
	export epro_bash='I am in ~/.bashrc'
	export ebash_bash='I am in ~/.bashrc'
	export pro_bash='I am in ~/.bashrc'
	```
	> **Tips:**  
	> 上面的变量声明位置要放在各个配置文件前面，但是要放在判别交互和登录模式之后  
	> /etc/profile 		最前面  
	> /etc/bash.bashrc	前面，但要在判断交互模式之后  
	> ~/.profile		最前面  
	> ~/.bashrc			前面，但要在判断交互模式之后

	* 试验步骤
		1. 登录模式  
		在终端中设置完上面的变量之后，以`bash -l`进入另一个bash，并显示上面的变量值
		![login]({{site.baseurl}}/assets/images/bash_login.png)  
		3. 交互模式  
		在终端中设置完上面的变量之后，以`bash -i`进入另一个bash，并显示上面的变量
		![inter]({{site.baseurl}}/assets/images/bash_inter.png)
		4. 打开terminal时，进入的模式  
		在一个终端中设置完上面的变量后，打开另一个终端，显示上面的变量值
		![terminal]({{site.baseurl}}/assets/images/terminal.png)  
	* 结论
		1. 登录模式中，四个文件都被执行了，执行的顺序是/etc/profile > /etc/bash.bashrc > ~/.profile > ~/.bashrc
		epro，pro，ebash，bash都有值，说明四个文件都被执行了。epro_ebash说明/etc/profile先于/etc/bash.bashrc;
		ebash_pro说明/etc/bash.bashrc先于~/.profile;pro_bash说明~/.profile先于~/.bashrc
		3. 交互模式中，两个profile文件没有被执行，两个bash文件都被执行了，并且/etc/bash.bashrc比~/.bashrc先执行
		ebash，bash都有值，说明bash两个文件都被执行了。ebash_bash说明~/.profile先于~/.bashrc
		4. 打开terminal时，进入交互模式
		两个profile文件没有被执行，两个bash文件都被执行了，并且/etc/bash.bashrc比~/.bashrc先执行。此状态和交互模式的状态一致。


## 待解决的问题
1. 非登录模式如何确定？
2. 之前的所有试验其实都包含了交互模式。非交互模式又如何确定？

## 参考文献
6. [shell的四种模式][bash]
1. [理解 bashrc 和 profile][bash_pro]
2. [Choosing between .bashrc, .profile, .bash_profile, etc][profile]


[bash]:		https://wiki.archlinux.org/index.php/Bash_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#.E4.BC.A0.E7.BB.9F.E6.A8.A1.E5.BC.8F
[bash_pro]:	https://wido.me/sunteya/understand-bashrc-and-profile
[profile]:	http://superuser.com/questions/789448/choosing-between-bashrc-profile-bash-profile-etc
