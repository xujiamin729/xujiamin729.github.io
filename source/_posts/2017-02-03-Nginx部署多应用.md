---
layout: post
title: Nginx部署多应用
categories:
- TECHNOLOGY
tags:
- Nginx
- Python
- Django
- Flask
permalink: server-multi-apps
comments: true
date: 2017-02-03 11:08:30
---

当拥有一个服务器后，发现有众多的应用想要部署在这个服务器上，而且想要为每个应用创建一个独有的二级域名，比如个人博客-blog.haojunyu.com,比如个人项目页面-pro.haojunyu.com等等，反正就是想要将自己所折腾的一切都放到这个服务器上，一方面算是给自己这么长时间在应用开发上的成果做个展示，另一方面是提醒自己不要再重复的造轮子，毕竟青春有限，还有很多其他的事情值得去尝试。这个以Nginx部署两个Python的Web框架Django和Flask为例。
<!-- more -->

在之前的博文中我们仿照[在Ubuntu上使用Nginx部署Flask应用][deploy-flask]在自己的服务器上成功部署了Flask应用，下面先在Ubuntu上使用Nginx部署Django应用，然后将二者合并在一起。

## Django应用
### 环境部署
我们使用virtualenv(virtualenvwrapper来管理虚拟环境)来部署Django应用，部署流程如下：
```bash
mkvirtualenv djangoEnv  #在$HOME/.virtualenvs/目录下创建djangoEnv环境
pip install django
# 后台使用mysql数据库
sudo apt install mysql-server-5.x
sudo apt install python-mysqldb
```

### 常用Django命令
基本的Django应用命令如下：
```bash
# 创建项目
django-amdin.py startproject djangoPro
# 重构数据库
python manage.py migrate
# 启动应用
python manage.py runserver 0.0.0.0:8090
# 创建应用模块
python manage.py startapp djangoApp
```

### Nginx配置
Django应用在Nginx服务上面的配置是参考的菜鸟教程上的[使用Nginx部署Django应用][nginx-django]。
  1. uwsgi配置
  和Flask应用一样，uwsgi是作为Django应用和Nginx服务器之间的桥梁的。配置如下：
  ```bash
  [uwsgi]
  socket = 127.0.0.1:8090
  master = true         //主进程
  vhost = true          //多站模式
  no-site = true        //多站模式时不设置入口模块和文件
  # workers = 2           //子进程数
  reload-mercy = 10     
  vacuum = true         //退出、重启时清理文件
  max-requests = 1000   
  limit-as = 512
  buffer-size = 30000
  pidfile = /var/www/django/django_uwsgi.pid    //pid文件，用于下面的脚本启动、停止该进程
  daemonize = /var/log/uwsgi/django_uwsgi.log
  ```
  2. Nginx配置
  ```bash
  server {
    listen      443;
    server_name django.haojunyu.com; #此时域名已经映射到主机IP

    ssl on;
    ssl_certificate /var/www/django/1_haojunyu.com_bundle.crt;
    ssl_certificate_key /var/www/django/2_haojunyu.com.key;
    ssl_session_timeout 5m;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2; #按照这个协议配置
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;#按照这个套件配置
    ssl_prefer_server_ciphers on;

    location / { try_files $uri @yourapplication; }
    location @yourapplication {
        include uwsgi_params;
        uwsgi_pass 127.0.0.1:8090;  # 和uwsgi中socket配置的值一致
        uwsgi_param UWSGI_SCRIPT djangoPro.wsgi;  # 入口文件，即wsgi.py相对于项目根目录的位置，这里.相当于一层目录
        uwsgi_param UWSGI_CHDIR /djangoPro; # 项目根目录
        index index.html index.htm;
        client_max_body_size 35m;
    }
  }
  ```
  > **TIPS:**
  > 1. 当我们使用`sudo server nginx restart`重启Nginx失败时，一定要善用`sudo nginx -t`命令来检测nginx.conf文件是否有问题。
  > 2. 这里uwsgi充当服务器和应用之间的桥梁作用，当浏览器访问返回`Bad GatWay`时就得用`ps -aux | grep uwsgi`来检测uwsgi服务有没有启动


## 合并多应用
这里对于Nginx配置多个应用，建议将各个不同应用的Nginx配置文件放在/etc/nging/conf.d/目录下，有几个应用就创建几个配置文件，这样易于管理和配置。

### 二级域名的使用
对于不同的应用，显然是不能使用相同的域名的，所以这就有了通过二级域名来区分不同的应用，这里分别用django.haojunyu.com来表示django应用，用flask.haojunyu.com来表示flask应用。在Nginx的配置文件中server_name就是相应的二级域名，而在域名解析中添加两条A记录，主机记录和记录值分别是django及对应的IP地址和flask及对应的IP地址。



## 参考文献
1. [在Ubuntu上使用Nginx部署Flask应用][deploy-flask]
1. [使用Nginx部署Django应用][nginx-django]

[deploy-flask]: https://www.oschina.net/translate/serving-flask-with-nginx-on-ubuntu
[nginx-django]: http://www.runoob.com/django/django-nginx-uwsgi.html:
