---
layout:	post
title:	快速部署日志分析系统ELK
categories:
- TECHNOLOGY
tags:
- Ubuntu
- OPS
permalink:  Explore-ELK
category:	[Ubuntu, OPS]
comments:	true
---
日志分析系统ELK是三个开源软件的缩写，分别是Elasticsearch，Logstash，Kibana。其中Elasticsearch是用来实现索引和搜索功能的目的，Logstash是一个很灵活的日志收集和处理工具。Kibana是和Elasticsearch配套的图形展示界面，用于方便的展示数据和分析数据。本文对整个套件的安装配置过程作了记录，并写了一键安装配置的脚本。
<!-- more -->

## 环境信息
* 操作系统 Ubuntu 14.04 64bit
* 依赖环境
	1. java环境

		```bash
		sudo apt-get install openjdk-7-jdk
		```
	2. redis[==单机时不用安装,CS模式中充当缓存队列==]

		```bash
		sudo apt-get install redis-server
		```

## Elasticsearch安装
1. 导入GPG key

	```bash
	wget -O - http://packages.elasticsearch.org/GPG-KEY-elasticsearch | sudo apt-key add -
	```
2. 添加elasticsearch到源（source list）中

	```bash
	echo 'deb http://packages.elasticsearch.org/elasticsearch/1.4/debian stable main' | sudo tee /etc/apt/sources.list.d/elasticsearch.list
	```
3. 更新软件包数据库

	```bash
	sudo apt-get update
	```
4. 安装elasticsearch

	```bash
	sudo apt-get -y install elasticsearch=1.4.4
	```
5. 配置elasticsearch[/etc/elasticsearch/elasticsearch.yml]
	....

6. 启动elasticsearch服务

	```bash
	sudo service elasticsearch restart
	```
7. 设置elasticsearch开机启动

	```bash
	sudo update-rc.d elasticsearch defaults 95 10
	```

## Logstash的安装
1. 添加logstash到源中

	```bash
	echo 'deb http://packages.elasticsearch.org/logstash/1.5/debian stable main' | sudo tee /etc/apt/sources.list.d/logstash.list
	```
2. 更新软件包数据库

	```bash
	sudo apt-get update
	```
3. 安装logstash

	```bash
	sudo apt-get install logstash
	```
4. 配置logstash[向/etc/logstash/conf.d/文件夹中添加配置文件]
	* 单机配置[single.conf]({{site.baseurl}}/assets/attachs/single.conf.txt)
	* 服务器端配置[indexer.conf]({{site.baseurl}}/assets/attachs/indexer.conf.txt)
	* 客户端配置[shipper.conf]({{site.baseurl}}/assets/attachs/shipper.conf.txt)
	* 其他配置 [inputs.conf]({{site.baseurl}}/assets/attachs/inputs.conf.txt) | [filters.conf]({{site.baseurl}}/assets/attachs/filters.conf.txt) | [outputs.conf]({{site.baseurl}}/assets/attachs/outputs.conf.txt) | [nginxlog_json.conf]({{site.baseurl}}/assets/attachs/nginxlog_json.conf.txt) & [ifo_nginx.conf]({{site.baseurl}}/assets/attachs/ifo_nginx.conf.txt) | [ifo_collectd.conf]({{site.baseurl}}/assets/attachs/ifo_collectd.conf.txt) | [ifo_syslog.conf]({{site.baseurl}}/assets/attachs/ifo_syslog.conf.txt)

	```bash
	# 单机配置
	sudo cp ./single.conf /etc/logstash/conf.d
	# 服务端配置
	sudo cp ./shipper.conf /etc/logstach/conf.d
	# 客户端配置
	sudo cp ./shipper.conf /etc/logstash/conf.d
	```
5. 启动logstash服务

	```bash
	sudo service logstash restart
	```
6. 设置logstash开机启动，比elasticsearch启动快，关闭慢

	```bash
	sudo update-rc.d logstash defaults 94 11
	```

## 安装Kabana
1. 下载kibana软件

	```bash
	wget -O /tmp/kibana.tar.gz https://download.elasticsearch.org/kibana/kibana/    kibana-4.0.1-linux-x64.tar.gz
	```
2. 解压到/opt/kibana

	```bash
	sudo tar xvf /tmp/kibana.tar.gz -C /opt/
	sudo mv /opt/kibana-4.0.1-linux-x64 /opt/kibana
	```
3. 配置kibana[向/opt/kibana/config中添加配置文件]

	```bash
	sudo cp ./kibana.yml /opt/kibana/config/
	sudo cp ./kibana4 /etc/init.d/
	```
4. 启动kibana服务器

	```bash
	sudo service kibana4 restart
	```
5. 设置kibana4开机启动，比elasticsearch启动慢，关闭快

	```bash
	sudo update-rc.d kibana4 defaults 96 9
	```

## 反向代理工具Nginx
1. 安装nginx和apache2-utils[有apache的web服务器内置工具，如htpasswd]

	```bash
	sudo apt-get -y install nginx apache2-utils
	```
2. 创建kibanaadmin用户来访问kibana网络接口，密码为kibanaadmin

	```bash
	sudo htpasswd -bc /etc/nginx/htpasswd.users kibanaadmin kibanaadmin
	```
3. 配置nginx[/etc/nginx/sites-available/default]

	```bash
	sudo cp ./default /etc/nginx/sites-available/
	```
4. 重启nginx服务

	```bash
	sudo service nginx restart
	```

## 构建SSL证书
目前还没有走通。


## 一键安装脚本
1. 多台机器协作
	* 服务端脚本[indexer.sh]({{site.baseurl}}/assets/attachs/indexer.sh.txt)
	* 客户端脚本[shipper.sh]({{site.baseurl}}/assets/attachs/shipper.sh.txt)
2. 单机独立运行
	* 独立脚本[single.sh]({{site.baseurl}}/assets/attachs/single.sh.txt)
